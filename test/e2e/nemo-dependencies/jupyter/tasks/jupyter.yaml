- name: Create notebook ConfigMap
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'notebook-configmap.yaml.j2') }}"

- name: Add JupyterHub Helm repo
  community.kubernetes.helm_repository:
    name: jupyterhub
    repo_url: https://jupyterhub.github.io/helm-chart/

- name: Install/Upgrade JupyterHub via Helm
  community.kubernetes.helm:
    name: "{{ helm_release_name }}"
    chart_ref: jupyterhub/jupyterhub
    release_namespace: "{{ namespace }}"
    values: "{{ lookup('template', 'values.yaml.j2') | from_yaml }}"
    wait: true
    state: present

- name: Wait for JupyterHub service to be available
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    name: "{{ service_name }}"
    namespace: "{{ namespace }}"
  register: jupyter_service
  until: jupyter_service.resources | length > 0
  retries: 30
  delay: 10

- name: Print access to Jupyter via port-forward
  debug:
    msg: |
      To access Jupyter Notebook, run the following command in your terminal:

        kubectl port-forward svc/{{ service_name }} -n {{ namespace }} 8888:80

      Then open http://localhost:8888/ in your browser.
      If prompted for a token, use: {{ jupyter_token }}
